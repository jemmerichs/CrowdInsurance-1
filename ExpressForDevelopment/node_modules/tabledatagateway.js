var queries = require('queries.js');
var logger = require('logger.js');

var getDBPromis = function(){
  var credentials;
  if (process.argv[2] != undefined && (process.argv[2].startsWith('postgres'))) {
    credentials = process.argv[2];
  } else{
    var dbconfig = require('dbconfig.js')
    credentials = dbconfig.url;
  }
  logger.consoleInfo('Setze die Datenbank-URL auf ' + credentials);
  var pgp = require('pg-promise')();
  var db = pgp(credentials);
  return db;
}

var db = getDBPromis();

//1. Einfache SELECT-Abfragen
//============================
//1.1 Versicherung
//-----------------
exports.selectVersicherungOf = function(personID, onSuccess, onError){
  var query = queries.selectVersicherungOf;
  db.any(query,personID).then(onSuccess).catch(onError);
}

exports.selectVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

//
//1.2 Investition
//-----------------
exports.selectInvestitionOf = function(personID, onSuccess, onError){
  var query = queries.selectInvestitionOf;
  db.any(query,personID).then(onSuccess).catch(onError);
}

exports.selectInvestitionen = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestitionen;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.selectInvestition = function(investitionID, onSuccess, onError){
  var query = queries.selectInvestition;
  db.any(query,investitionID).then(onSuccess).catch(onError);
}

//
//1.3 Investoren/Investitionssumme von Versicherung
//--------------------------------------------------
exports.selectInvestorenVonVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestorenVonVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.selectInvestitionsSumVonVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestitionsSumVonVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

//
//2. Einfache INSERT-Anweisungen
//===============================
//2.1 Versicherung
//-----------------
exports.erstelleVersicherung = function(personID, name, versicherungshoehe, beitrag, beschreibung, onSuccess, onError){
  var query = queries.insertVersicherung;
  db.any(query, [personID, name, versicherungshoehe, beitrag, beschreibung]).then(onSuccess).catch(onError);
}

exports.insertZahlung = function(versicherungID, personID, betrag, onSuccess, onError){
  var query = queries.insertZahlung;
  db.any(query, [versicherungID,personID,betrag]).then(onSuccess).catch(onError);
}

//
//3. Einfache UPDATE-Anfragen
//==========================================
exports.updateVersicherungGekuendigt = function(onSuccess, onError){
  var query = queries.updateVersicherungGekuendigt;
  db.any(query).then(onSuccess).catch(onError);
}

exports.investitionKuendigungEinreichen = function(investitionID, onSuccess, onError){
  var query = queries.updateInvestitionWirdGekuendigt;
  db.any(query, investitionID).then(onSuccess).catch(onError);
}

//
//4. Komplexe / Zusammengesetzte Abfragen
//==========================================
//4.1 Investition und Investitionszahlung eintragen
//-------------------------------------------------
exports.erstelleInvestition = function(versicherungID, personID, betrag, onSuccess, onError){
  var query = queries.tranInvestieren;
  db.any(query, [versicherungID,personID,betrag]).then(onSuccess).catch(onError);
}

//
//4.2 Versicherung kuendigung einreichen und dazugehoerige Investition kuendigung einreichen
//---------------------------------------------------------------------------------------------
exports.versicherungKuendigungEinreichen = function(versicherungID, onSuccess, onError){
  var query = queries.tranVersicherungWirdGekuendigt;
  db.any(query, versicherungID).then(onSuccess).catch(onError);
}

//
//4.3 Investition zurueckzahlen und Investition tatsaechlich kuendigen
//---------------------------------------------------------------------
exports.investitionKuendigen = function(onSuccess, onError){
  var query = queries.tranInvestitionKuendigen;
  db.any(query).then(onSuccess).catch(onError);
}

//
//4.4 Sonstige ;-) //TODO: Kommentare einfuegen
//
exports.getPaymentrelevantInvestitions = function(onSuccess, onError){
  var query = queries.getPaymentrelevantInvestitions;
  db.any(query).then(onSuccess).catch(onError);
}

exports.selectActiveVersicherungAndCalculateBeitrag = function(onSuccess, onError){
  var query = queries.selectActiveVersicherungAndCalculateBeitrag;
  db.any(query).then(onSuccess).catch(onError);
}
