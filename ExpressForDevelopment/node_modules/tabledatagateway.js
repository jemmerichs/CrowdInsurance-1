var queries = require('queries.js');

var getDBPromis = function(){
  var credentials = require('dbconfig.js');
  var pgp = require('pg-promise')();
  var db = pgp(credentials.url);
  return db;
}

var db = getDBPromis();

exports.selectVersicherungOf = function(personID, onSuccess, onError){
  var query = queries.selectVersicherungOf;
  db.any(query,personID).then(onSuccess).catch(onError);
}

exports.selectVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.erstelleVersicherung = function(personID, name, versicherungshoehe, beitrag, beschreibung, abschlussZeitpunkt, onSuccess, onError){
  var query = queries.insertVersicherung;
  var istGekuendigt = "false";
  db.any(query, [personID, name, versicherungshoehe, beitrag, beschreibung, abschlussZeitpunkt, istGekuendigt]).then(onSuccess).catch(onError);
}

exports.erstelleInvestition = function(versicherungID, personID, abschlussZeitpunkt, betrag, onSuccess, onError){
  var query = queries.tranInvestieren;
  var istGekuendigt = "false";
  db.any(query, [versicherungID,personID,abschlussZeitpunkt,betrag,istGekuendigt]).then(onSuccess).catch(onError);
}

exports.selectInvestitionOf = function(personID, onSuccess, onError){
  var query = queries.selectInvestitionOf;
  db.any(query,personID).then(onSuccess).catch(onError);
}

exports.selectInvestitionen = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestitionen;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.selectInvestition = function(investitionID, onSuccess, onError){
  var query = queries.selectInvestition;
  db.any(query,investitionID).then(onSuccess).catch(onError);
}

exports.selectInvestorenVonVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestorenVonVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.selectInvestitionsSumVonVersicherung = function(versicherungID, onSuccess, onError){
  var query = queries.selectInvestitionsSumVonVersicherung;
  db.any(query,versicherungID).then(onSuccess).catch(onError);
}

exports.getPaymentrelevantInvestitions = function(onSuccess, onError){
  var query = queries.getPaymentrelevantInvestitions;
  db.any(query).then(onSuccess).catch(onError);
}





//Alte Funktionen:
exports.getVersicherung = function (req, res, next) {
  var param, query;
  if(req.query.id != undefined){
    param = req.query.id;
    query = require('queries.js').getVersicherungByID;
  } else if(req.query.personid != undefined){
    param = req.query.personid;
    console.log("count: " + req.query.count);
    if(req.query.count == undefined || req.query.count == false){
      query = require('queries.js').getVersicherungByPerson;
    } else {
      query = require('queries.js').getVersicherungCountByPerson;
    }
  } else{
    res.status(406).send('Ungueltige Parameter!'); return;
  }
  var db = getDBPromis();
  db.any(query,param).then(
    function(data){
      res.status(200).json({
        status: 'success',
        data: data,
    });}
  ).catch(
    function(err){
      return next(err);
    }
  );
}



exports.getSchadensfaelle = function (req, res, next) {
  var query = 'SELECT "id", "versicherungID", "beschreibung", "schadenshoehe", "zeitpunkt", "auszahlungsZeitpunkt", "Auszahlungsstatus" FROM "smartinsurance"."Schadensfall";';
  var successCallback = function(data){sendDataResponse(data);}
  var errorCallback = function(err){return next(err);};
  sendDBQuery(query, successCallback, errorCallback);
}

exports.getVersicherungen = function (req, res, next) {
  var credentials = require('dbconfig.js');
  var pgp = require('pg-promise')();
  var db = pgp(credentials.url);

  db.any('SELECT id, "personID", name, versicherungshoehe, beitrag, bezeichnung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt" FROM "Versicherung";').then(
   function (data) {
    res.status(200).json({
        status: 'success',
        data: data,
      });
    }).catch(function (err) {
      return next(err);
   });
}

exports.gib = function (callback){
  var pgp = require('pg-promise');
  var dbconfig = require('dbconfig.js');

  var client = new pg.Client(dbconfig.url);
  client.connect();
  var query = client.query('SELECT "ID", name FROM "Versicherungsobjekt"');
  var results = [];
  query.on('row', function(row) {
    results.push({
      id : row.ID,
      name : row.name
    });
  });
  query.on('end', function() {
    client.end();
    callback(results);
  });
}
