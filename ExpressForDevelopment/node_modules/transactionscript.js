var tdg = require('tabledatagateway.js');
var q = require('q');
var logger = require('logger.js');
var periodNumber = 0;
var personID = "bfa73b02-21f7-11e6-b56d-6ffe69564a95";
var internal = new Object();

// Datenbankabfragen angestoßen durch den Client
//==============================================
// Daten laden
//-------------
// Lade alle Versicherungen der Person, die die Anfrage stellt
exports.getVersicherungOf = function (req, res, next) {
  tdg.selectVersicherungOf(personID,
    function(data){
      logger.info('Versicherungen der Person ' + personID + 'erfolgreich geladen.');
      res.status(200).json(data);
    },
    function(err){
      logger.error('Fehler beim Laden der Versicherungen der Person ' + personID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Versicherungen.');
    }
  );
};

// Lade alle Felder einer Versicherungs nach der Versicherungs ID
exports.getVersicherung = function (req, res, next) {
  var versicherungID = req.params.versicherungID;

  tdg.selectVersicherung(versicherungID,
    function(data){
      logger.info('Versicherung ' + versicherungID + 'erfolgreich geladen.');
      if(data[0].id != null) {
          res.status(200).json(data);
      } else{
          res.status(404).send('Versicherung mit ID ' + versicherungID + ' wurde nicht gefunden.')
      }
    },
    function(err){
      logger.error('Fehler beim Laden der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Versicherung.');
    }
  );
}

exports.getBewertungen = function (req, res, next) {
  var versicherungID = req.params.versicherungID;

  tdg.selectBewertungen(versicherungID,
    function(data){
      logger.info('Bewertungen der Versicherung ' + versicherungID + 'erfolgreich geladen.');
      if(data.length != 0) {
          res.status(200).json(data);
      } else{
          res.status(404).send('Bewertungen der Versicherung ' + versicherungID + ' wurde nicht gefunden. Das heißt die Versicherung existiert nicht oder hat keine Investitionen.')
      }
    },
    function(err){
      logger.error('Fehler beim Laden der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Versicherung.');
    }
  );
}

// Filtern und sortieren der Versicherungen
exports.filterVersicherung = function (req, res, next) {
  var withFilter = true;
  var kategorie = req.body.kategorie;
  var orderby = req.body.orderby;
  if (orderby == undefined) orderby = "id";
  var asc_desc = req.body.ascending;
  if (asc_desc == undefined) asc_desc = true;
  // var orderbyindex = 1;

  // Mit oder ohne where Bedingung?
  if (kategorie == undefined) {
    withFilter = false;
  }

  // Bestimmen des Indexes der Spalte für die Sortierung
  // switch (orderby) {
  //   case "id": orderbyindex = 1; break;
  //   case "name": orderbyindex = 2; break;
  //   case "versicherungshoehe": orderbyindex = 3; break;
  //   case "beitrag": orderbyindex = 4; break;
  //   case "beschreibung": orderbyindex = 5; break;
  //   case "abschlussZeitpunkt": orderbyindex = 6; break;
  //   case "kuendigungsZeitpunkt": orderbyindex = 7; break;
  //   case "istGekuendigt": orderbyindex = 8; break;
  //   case "wirdGekuendigt": orderbyindex = 9; break;
  //   case "personID": orderbyindex = 10; break;
  //   case "kategorie": orderbyindex = 11; break;
  //   case "anzahl_investoren": orderbyindex = 12; break;
  //   case "bewertung": orderbyindex = 13; break;
  //   case "rendite" : orderbyindex = 14; break;
  //   default: orderbyindex = 1; logger.consoleInfo('Cannot sort by '+orderby+' using id instead'); break;
  // }

  if (withFilter) {
    tdg.filterVersicherung(kategorie, orderby, asc_desc,
      function(data){
        logger.info('Filter Kategorie auf ' + kategorie + ' Sortierunger nach ' + orderby + ' ' + (asc_desc==="ascending")?'austeigend.':'absteigend.');
        if(data.length != 0) {
            res.status(200).json(data);
        } else{
            res.status(404).send('Filter Kategorie auf '  + kategorie + ' Sortierunger nach ' + orderby + ' ' + (asc_desc==="ascending")?'austeigend.':'absteigend fehlgeschlagen.')
        }
      },
      function(err){
        logger.info('Fehler beim Filtern'+ ' - ' + err);
        res.status(500).send('Fehler beim Filtern');
      }
    );
  } else {
    tdg.orderVersicherung(orderby, asc_desc,
      function(data){
        logger.info('Sortierunger nach ' + orderby + ' ' + (asc_desc==="ascending")?'austeigend.':'absteigend.');
        if(data.length != 0) {
            res.status(200).json(data);
        } else{
            res.status(404).send('Sortierunger nach ' + orderby + ' ' + (asc_desc==="ascending")?'austeigend.':'absteigend fehlgeschlagen.')
        }
      },
      function(err){
        logger.info('Fehler beim Sortieren'+ ' - ' + err);
        res.status(500).send('Fehler beim Sortieren');
      }
    );
  }
}

// Lade alle Kategorien
exports.getKategorien = function (req, res, next) {
  tdg.selectKategorien(
    function(data){
      logger.info('Kategorien erfolgreich geladen.');
      data = data[0].getkategorien;
      data = data.substring(1,data.length-2);
      listOfKategorien = data.split(/,/);
      res.status(200).json(listOfKategorien);
    },
    function(err){
      logger.error('Fehler beim Laden der Kategorien - ' + err);
      res.status(500).send('Fehler beim Laden der Kategorien');
    }
  );
};

// Lade alle Investitionen der Person, die die Anfrage stellt
exports.getInvestitionOf = function (req, res, next) {
  tdg.selectInvestitionOf(personID,
    function(data){
      logger.info('Investitionen der Person ' + personID + 'erfolgreich geladen.');
      res.status(200).json(data);
    },
    function(err){
      logger.error('Fehler beim Laden der Investitionen der Person ' + personID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Investitionen.');
    }
  );
}

// Lade alle Investitionen einer Versicherung nach der Versicherungs ID
exports.listOfInvestitionen = function (req, res, next) {
  var versicherungID = req.params.versicherungID;
  tdg.selectInvestitionen(versicherungID,
    function(data){
      logger.info('Investitionen der Versicherung ' + versicherungID + 'erfolgreich geladen.');
      if(data.length != 0){
        res.status(200).json(data);
      } else{
        res.status(404).send('Keine Investitionen und/oder die Versicherung existiert nicht.');
      }
    },
    function(err){
      logger.error('Fehler beim Laden der Investitionen der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Investitionen.');
    }
  );
}

// Lade alle Felder einer Investition nach der Investitions ID
exports.getInvestition = function (req, res, next) {
  var investitionID = req.params.investitionID;
  tdg.selectInvestition(investitionID,
    function(data){
      logger.info('Investition ' + investitionID + 'erfolgreich geladen.');
      if(data[0].id != null) {
          res.status(200).json(data);
      } else{
          res.status(404).send('Investition nicht gefunden.');
      }
    },
    function(err){
      logger.error('Fehler beim Laden der Investition ' + investitionID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Investition.');
    }
  );
}

// Lade alle PersonenIDs einer Versicherung
exports.getInvestorenVonVersicherung = function (req, res, next) {
  var versicherungID = req.params.versicherungID;
  tdg.selectInvestorenVonVersicherung(versicherungID,
    function(data){
      logger.info('Investoren von Versicherung ' + versicherungID + 'erfolgreich geladen.');
      if(data[0].versicherungID != null){
          res.status(200).json(data);
      }  else{
          res.status(404).send('Versicherung nicht gefunden.');
      }
    },
    function(err){
      logger.error('Fehler beim Laden der Investoren der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Laden der Personen.');
    }
  );
}

// Summiere alle aktuellen (=nicht gekuendigten) Investitionswerte einer Versicherung
exports.calculateSumOfInvestVersicherung = function (req, res, next) {
  var versicherungID = req.params.versicherungID;
  tdg.selectInvestitionsSumVonVersicherung(versicherungID,
    function(data){
      logger.info('Kalkulieren der Investitionssumme der Versicherung ' + versicherungID + ' erfolgreich durchgeführt.');
      data[0] = {"suminvestition":data[0].getinvestitionssummebyvid};
      if(data[0].suminvestition != null) {
          res.status(200).json(data);
      } else{
          res.status(404).send('Versicherung nicht gefunden.');
      }
    },
    function(err){
      logger.error('Fehler beim Kalkulieren der Investitionssumme der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Kalkulieren der Investitionssumme.');
    }
  );
}

//
// Erstellen / Anlegen von Versicherung und Investition
//-----------------------------------------------------
// Investition erstellen
exports.erstelleInvestition = function (req, res, next) {
  var versicherungID = req.body.versicherungID;
  var betrag = req.body.investitionswert;

  tdg.erstelleInvestition(versicherungID, personID, betrag,
    function(data){
      logger.info('Investition für die Versicherung ' + versicherungID + ' mit einem Betrag von ' + betrag + ' erfolgreich erstellt.');
      res.status(201).json(data);
    },
    function(err){
      logger.error('Fehler beim Erstellen einer Investition für die Versicherung ' + versicherungID + ' mit einem Betrag von ' + betrag + ' - ' + err);
      res.status(500).send('Fehler beim Erstellen der Investition.');
    }
  );
}

// Versicherung erstellen
exports.erstelleVersicherung = function (req, res, next) {
  var name = req.body.name;
  var versicherungshoehe = req.body.versicherungshoehe;
  var beitrag = req.body.beitrag;
  var beschreibung = req.body.beschreibung;
  if(beschreibung == undefined){
    beschreibung = '';
  }
  var kategorie = req.body.kategorie;

  logger.consoleInfo(name + " " + versicherungshoehe + " " + beitrag + " " + beschreibung + " " + kategorie);

  tdg.erstelleVersicherung(personID, name, versicherungshoehe, beitrag, beschreibung, kategorie, //abschlussZeitpunkt,
    function(data){
      logger.info('Versicherung mit dem Namen ' + name + ', der Versicherungshöhe ' + versicherungshoehe
                    + ' und mit einem Beitrag von ' + beitrag + ' erfolgreich erstellt.');
      res.status(201).json(data);
    },
    function(err){
      logger.error('Fehler beim Erstellen der Versicherung mit dem Namen ' + name + ', der Versicherungshöhe ' + versicherungshoehe
                    + ' und mit einem Beitrag von ' + beitrag + ' - ' + err);
      res.status(500).send('Fehler beim Erstellen der Versicherung.');
    }
  );
}

//
// Kuendigung einreichen
//-----------------------------
// Kuendigung einer Versicherung einreichen (zzgl. der Einreichung der Kuendigung fue dazugehoerige Investitionen)
exports.versicherungKuendigungEinreichen = function (req, res, next) {
  var versicherungID = req.params.versicherungID;
  tdg.versicherungKuendigungEinreichen(versicherungID,
    function(data){
      logger.info('Kündigung der Versicherung ' + versicherungID + ' erfolgreich eingereicht.');
      res.status(200).json('Kündigung der Versicherung erfolgreich eingereicht.');
    },
    function(err){
      logger.error('Fehler beim Einreichen der Kündigung der Versicherung ' + versicherungID + ' - ' + err);
      res.status(500).send('Fehler beim Einreichen der Kündigung der Versicherung.');
    }
  );
}

// Kuendigung einer Investition einreichen
exports.investitionKuendigungEinreichen = function (req, res, next) {
  var investitionID = req.params.investitionID;
  tdg.investitionKuendigungEinreichen(investitionID,
    function(data){
      logger.info('Kündigung der Investition ' + investitionID + ' erfolgreich eingereicht.');
      res.status(200).json('Kündigung der Investition erfolgreich eingereicht.');
    },
    function(err){
      logger.error('Fehler beim Einreichen der Kündigung der Investition ' + investitionID + ' - ' + err);
      res.status(500).send('Fehler beim Einreichen der Kündigung der Investition.');
    }
  );
}

//
// Abhandlung der Perioden
//===============================
/*
  Die periodische Verarbeitung steuert die Zahlungsstroeme
    - Auszahlen der Schadenshoehe zum Ende des Kuendigungszeitraums verarbeiten
   - Kuendigungen von Versicherungen und Investitionen zum Ende des Kuendigungszeitraums verarbeiten
   - Einziehen der Versicherungsbeitraege
   - Auszahlung der Rendite
*/
exports.periodicSchedule = function (req,res,next) {
  logger.consoleInfo('Berechne Periode ' + periodNumber);
  q.fcall(function(){return new q.Promise(exports.auszahlungSchadensfaelle)})
  .then(function(){return new q.Promise(exports.versicherungKuendigungenVerarbeiten)})
  .then(function(){return new q.Promise(exports.investitionKuendigungenVerarbeiten)})
  .then(function(){return new q.Promise(exports.einziehenVersicherungsbeitraege)})
  .then(function(){return new q.Promise(exports.auszahlungRendite)})
  .catch(function (err){
    logger.error('Es ist ein Fehler im periodicSchedule aufgetreten: ' + err);
  })
  .done();
  periodNumber += 1;

  if(res != undefined){
    res.status(200).send('Periode erfolgreich berechnet.');
  }
}

exports.auszahlungSchadensfaelle = function(resolve, reject, notify) {
  // Für alle Schadensfälle mit istAusgezahlt = false:
    // Zahlung an den Versicherungsnehmer
    // Setze istAusgezahlt = true
    resolve();
}

exports.versicherungKuendigungenVerarbeiten = function(resolve, reject, notify) {
  // Für alle Versicherungen die wirdGekuendigt = true haben:
    // Setze istGekuendigt = true
  tdg.updateVersicherungGekuendigt(
    function(data){
      //log versicherungsskuendigungen erfolgreich abgeschlossen
      resolve();
    },
    function(err){
      logger.error('Es ist ein Fehler bei der Kündiungsroutine der Versicherungen aufgetreten - ' + err);
      //log fehler bei verischerung kuendigen
    }
  );
}

exports.investitionKuendigungenVerarbeiten = function(resolve, reject, notify) {
  // Für alle Invesitionen die wirdGekuendigt = true haben:
    // Zahlung von der Versicherung an den Investor
    // Setze istGekuendigt = true
  tdg.investitionKuendigen(
    function(data){
      //log investitionskuendigungen erfolgreich abgeschlossen
      resolve();
    },
    function(err){
      logger.error('Es ist ein Fehler bei der Kündiungsroutine der Investitionen aufgetreten - ' + err);
      reject();
    }
  );
}

exports.einziehenVersicherungsbeitraege = function(resolve, reject, notify) {
  // Laufende Versicherungen laden
  // Fuer jede Versicherung bestimmen, wie hoch die Investitionssumme ist und den Beitrag bestimmen
  tdg.selectActiveVersicherungAndCalculateBeitrag(
    function(data) {
      // Die Zahlungen ausfuehren
      internal.beitragEinziehen(data);
      resolve();
    },
    function(err) {
      logger.error('Es ist ein Fehler beim Einziehen der Versicherungsbeiträge aufgetreten - ' + err);
      reject();
    }
  );
}

internal.beitragEinziehen = function(data) {
  for (var i = 0, versicherung; versicherung = data[i]; i++) {
    logger.info('Einzug eines Beitrags ' + JSON.stringify(versicherung));
    tdg.insertZahlung(versicherung.id,versicherung.personID, versicherung.echterBeitrag);
  }
};

exports.auszahlungRendite = function(resolve, reject, notify) {
  tdg.getPaymentrelevantInvestitions(
    function(data) {
      internal.renditeAuszahlen(data);
      resolve();
    },
    function(err) {
      logger.error('Es ist ein Fehler beim Einziehen der Versicherungsbeiträge aufgetreten - ' + err);
    }
  );
}

internal.renditeAuszahlen = function(data) {
  for (var i = 0, investition; investition = data[i]; i++) {
    logger.info('Auszahlung einer Rendite ' + JSON.stringify(investition));
    tdg.insertZahlung(investition.id,investition.personID, "-" + investition.rendite);
  }
}

exports.getPaymentrelevantInvestitions = function(req,res,next){
  tdg.getPaymentrelevantInvestitions(
    function(data){
      res.json(data);
    },
    function(){
      res.send('fail');
    }
  );
}
