//1. Einfache SELECT-Abfragen
//============================
//1.1 Versicherung
//-----------------
exports.selectVersicherung = 'SELECT id, "personID", name, versicherungshoehe,'
  + ' beitrag, beschreibung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
  + ' FROM "Versicherung" WHERE id=$1;';

exports.selectVersicherungOf = 'SELECT id, "personID", name, versicherungshoehe,'
  + ' beitrag, beschreibung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
  + ' FROM "Versicherung" WHERE "personID"=$1;';

// exports.selectVersicherungCountByPerson = 'SELECT count(*) as count FROM "Versicherung"'
//   + ' WHERE "personID"=$1 GROUP BY "personID"';

//
//1.2 Investition
//-----------------
exports.selectInvestition = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
  + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
  + ' FROM "Investition" WHERE id=$1;';

exports.selectInvestitionOf = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
  + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
  + ' FROM "Investition" WHERE "personID"=$1;';

exports.selectInvestitionen = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
  + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
  + ' FROM "Investition" WHERE "versicherungID"=$1;';

//
//1.3 Investoren/Investitionssumme von Versicherung
//--------------------------------------------------
exports.selectInvestorenVonVersicherung = 'SELECT "Investition"."personID"'
  + ' FROM "Versicherung" INNER JOIN "Investition"'
  + ' ON "Versicherung".id="Investition"."versicherungID" WHERE "Versicherung".id=$1;';

exports.selectInvestitionsSumVonVersicherung = 'SELECT'
  + ' sum("Investition"."investitionshoehe") as suminvestition'
  + ' FROM "Versicherung" INNER JOIN "Investition"'
  + ' ON "Versicherung".id="Investition"."versicherungID" WHERE "Versicherung".id=$1'
  + ' AND "Investition"."istGekuendigt"=false;' ;

//
//1.4 Bewertung
//-----------------
exports.bewertung = 'SELECT "versicherungID", "bewertung", COUNT("bewertung")'
  + 'FROM "Investition" WHERE "versicherungID" = $1'
  + 'GROUP BY 1,2 ORDER BY 1,2;';

//
//2. Einfache INSERT-Anweisungen
//===============================
//2.1 Versicherung
//-----------------
exports.insertVersicherung = 'INSERT INTO "Versicherung"("personID", name,'
  + ' versicherungshoehe, beitrag, beschreibung)'
  + ' VALUES ( $1, $2, $3, $4, $5);';

//
//2.2 Investition
//-----------------
exports.insertInvestition = 'INSERT INTO "Investition"("versicherungID", "personID",'
  + ' investitionshoehe)'
  + ' VALUES ($1, $2, $3);'

//
//2.3 Zahlung
//-----------------
exports.insertZahlung = 'INSERT INTO "Zahlungsstrom"("versicherungID",'
  + ' "personID", betrag)'
  + ' VALUES ($1, $2, $3);';

//
//3. Einfache UPDATE-Anfragen
//==========================================
exports.updateVersicherungGekuendigt = 'UPDATE "Versicherung"'
  + ' SET "istGekuendigt"=true, "wirdGekuendigt"=false, "kuendigungsZeitpunkt"=now() WHERE "wirdGekuendigt"=true;' //WICHTIG: wirdGekuendigt muss auf false gesetzt werden

exports.updateInvestitionGekuendigt = 'UPDATE "Investition"'
  + ' SET "istGekuendigt"=true, "wirdGekuendigt"=false, "kuendigungsZeitpunkt"=now() WHERE "wirdGekuendigt"=true;' //WICHTIG: wirdGekuendigt muss auf false gesetzt werden

exports.updateVersicherungWirdGekuendigt = 'UPDATE "Versicherung"'
  + ' SET "wirdGekuendigt"=true WHERE id=$1;'

exports.updateInvestitionWirdGekuendigt = 'UPDATE "Investition"'
  + ' SET "wirdGekuendigt"=true WHERE id=$1 AND "istGekuendigt"=false;'

//
//4. Komplexe / Zusammengesetzte Abfragen
//==========================================
//4.1 Investition und Investitionszahlung eintragen
//-------------------------------------------------
exports.tranInvestieren = 'BEGIN;'
  + exports.insertInvestition
  + exports.insertZahlung
  + 'COMMIT;';

//
//4.2 Versicherung kuendigung einreichen und dazugehoerige Investition kuendigung einreichen
//---------------------------------------------------------------------------------------------
exports.tranVersicherungWirdGekuendigt = 'BEGIN;'
  + exports.updateVersicherungWirdGekuendigt
  + 'UPDATE "Investition" SET "wirdGekuendigt"=true WHERE "versicherungID"=$1 AND "istGekuendigt"=false;'
  + 'COMMIT;'

//
//4.3 Investition zurueckzahlen und Investition tatsaechlich kuendigen
//---------------------------------------------------------------------
exports.tranInvestitionKuendigen = 'BEGIN;'
  + ' INSERT INTO "Zahlungsstrom"("versicherungID", "personID", betrag)'
  + ' SELECT "versicherungID", "personID", investitionshoehe * (-1) FROM "Investition" WHERE "Investition"."wirdGekuendigt"=true;'
  + exports.updateInvestitionGekuendigt
  + 'COMMIT;'

//
//4.4 Sonstige ;-) //TODO: Kommentare einfuegen
//
exports.getPaymentrelevantInvestitions = 'SELECT "v"."id", "i"."personID", "v"."beitrag" * ("i"."invest"/"v"."versicherungshoehe") as "rendite" FROM '
  + '(SELECT "id", "personID", "beitrag", "versicherungshoehe" FROM "Versicherung" WHERE "istGekuendigt"=FALSE) "v" '
  + 'right join '
  + '(SELECT "personID", "versicherungID", sum("investitionshoehe") as "invest" FROM "Investition" WHERE "istGekuendigt"=FALSE GROUP BY "personID", "versicherungID") "i" '
  + 'on "v"."id" = "i"."versicherungID" ;'  //und "wirdGekuendigt" = false????

exports.selectActiveVersicherungAndCalculateBeitrag =
  'SELECT "v"."id", "v"."personID", "v"."versicherungshoehe", "v"."beitrag", "i"."invest", '
  + '"i"."invest"/"v"."versicherungshoehe" as "deckung", "v"."beitrag" * ("i"."invest"/"v"."versicherungshoehe") as "echterBeitrag" from '
  + '(SELECT "id", "personID", "beitrag", "versicherungshoehe" FROM "Versicherung" WHERE "istGekuendigt"=FALSE) "v" '
  + 'left join '
  + '(SELECT "versicherungID", sum("investitionshoehe") as "invest" FROM "Investition" WHERE "istGekuendigt"=FALSE GROUP BY "versicherungID") "i" '
  + 'on "v"."id" = "i"."versicherungID" ;'
