//1. Einfache SELECT-Abfragen
//============================
//1.1 Versicherung
//-----------------
// exports.selectVersicherung = 'SELECT id, "personID", name, versicherungshoehe,'
//   + ' beitrag, beschreibung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt", kategorie'
//   + ' FROM smartinsurance."Versicherung" WHERE id=$1;';

// exports.selectVersicherungOf = 'SELECT id, "personID", name, versicherungshoehe,'
//   + ' beitrag, beschreibung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt", kategorie'
//   + ' FROM smartinsurance."Versicherung" WHERE "personID"=$1;';

exports.filterVersicherung = 'SELECT "id","name","versicherungshoehe","beitrag","beschreibung","abschlussZeitpunkt","kuendigungsZeitpunkt","istGekuendigt","wirdGekuendigt","personID","kategorie","anzahl_investoren","bewertung","rendite" FROM smartinsurance."VersicherungFilter" WHERE "kategorie" = $1 ORDER BY $2 ';
exports.orderVersicherung = 'SELECT "id","name","versicherungshoehe","beitrag","beschreibung","abschlussZeitpunkt","kuendigungsZeitpunkt","istGekuendigt","wirdGekuendigt","personID","kategorie","anzahl_investoren","bewertung","rendite" FROM smartinsurance."VersicherungFilter" ORDER BY $1 ';
// exports.selectVersicherungCountByPerson = 'SELECT count(*) as count FROM smartinsurance."Versicherung"'
//   + ' WHERE "personID"=$1 GROUP BY "personID"';

exports.selectKategorien = 'SELECT enum_range(NULL::kategorie);';

//
//1.3 Investition
//-----------------
// exports.selectInvestition = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
//   + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
//   + ' FROM smartinsurance."Investition" WHERE id=$1;';

// exports.selectInvestitionOf = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
//   + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
//   + ' FROM smartinsurance."Investition" WHERE "personID"=$1;';

// exports.selectInvestitionen = 'SELECT id, "versicherungID", "personID", investitionshoehe,'
//   + ' bewertung, "abschlussZeitpunkt", "kuendigungsZeitpunkt", "istGekuendigt"'
//   + ' FROM smartinsurance."Investition" WHERE "versicherungID"=$1;';

//
//1.4 Investoren/Investitionssumme von Versicherung
//--------------------------------------------------
exports.selectInvestorenVonVersicherung = 'SELECT smartinsurance."Investition"."personID"'
  + ' FROM smartinsurance."Versicherung" INNER JOIN smartinsurance."Investition"'
  + ' ON smartinsurance."Versicherung".id=smartinsurance."Investition"."versicherungID" WHERE smartinsurance."Versicherung".id=$1;';

exports.selectInvestitionsSumVonVersicherung = 'SELECT'
  + ' sum(smartinsurance."Investition"."investitionshoehe") as suminvestition'
  + ' FROM smartinsurance."Versicherung" INNER JOIN smartinsurance."Investition"'
  + ' ON smartinsurance."Versicherung".id=smartinsurance."Investition"."versicherungID" WHERE smartinsurance."Versicherung".id=$1'
  + ' AND smartinsurance."Investition"."istGekuendigt"=false;' ;

//
//1.5 Bewertung
//-----------------
// exports.bewertung = 'SELECT "versicherungID", "bewertung", COUNT("bewertung")'
//   + 'FROM smartinsurance."Investition" WHERE "versicherungID" = $1'
//   + 'GROUP BY 1,2 ORDER BY 1,2;';

//
//2. Einfache INSERT-Anweisungen
//===============================
//2.1 Versicherung
//-----------------
exports.insertVersicherung = 'INSERT INTO smartinsurance."Versicherung"("personID", name,'
  + ' versicherungshoehe, beitrag, beschreibung, kategorie)'
  + ' VALUES ( $1, $2, $3, $4, $5, $6);';

//
//2.2 Investition
//-----------------
// exports.insertInvestition = 'INSERT INTO smartinsurance."Investition"("versicherungID", "personID",'
//   + ' investitionshoehe)'
//   + ' VALUES ($1, $2, $3);'

//
//2.3 Zahlung
//-----------------
exports.insertZahlung = 'INSERT INTO smartinsurance."Zahlungsstrom"("versicherungID",'
  + ' "personID", betrag)'
  + ' VALUES ($1, $2, $3);';

//
//3. Einfache UPDATE-Anfragen
//==========================================
exports.updateVersicherungGekuendigt = 'UPDATE smartinsurance."Versicherung"'
  + ' SET "istGekuendigt"=true, "wirdGekuendigt"=false, "kuendigungsZeitpunkt"=now() WHERE "wirdGekuendigt"=true;' //WICHTIG: wirdGekuendigt muss auf false gesetzt werden

exports.updateInvestitionGekuendigt = 'UPDATE smartinsurance."Investition"'
  + ' SET "istGekuendigt"=true, "wirdGekuendigt"=false, "kuendigungsZeitpunkt"=now() WHERE "wirdGekuendigt"=true;' //WICHTIG: wirdGekuendigt muss auf false gesetzt werden

exports.updateVersicherungWirdGekuendigt = 'UPDATE smartinsurance."Versicherung"'
  + ' SET "wirdGekuendigt"=true WHERE id=$1;'

exports.updateInvestitionWirdGekuendigt = 'UPDATE smartinsurance."Investition"'
  + ' SET "wirdGekuendigt"=true WHERE id=$1 AND "istGekuendigt"=false;'

//
//4. Komplexe / Zusammengesetzte Abfragen
//==========================================
//4.1 Investition und Investitionszahlung eintragen
//-------------------------------------------------
// exports.tranInvestieren = 'BEGIN;'
//   + exports.insertInvestition
//   + exports.insertZahlung
//   + 'COMMIT;';

//
//4.2 Versicherung kuendigung einreichen und dazugehoerige Investition kuendigung einreichen
//---------------------------------------------------------------------------------------------
exports.tranVersicherungWirdGekuendigt = 'BEGIN;'
  + exports.updateVersicherungWirdGekuendigt
  + 'UPDATE smartinsurance."Investition" SET "wirdGekuendigt"=true WHERE "versicherungID"=$1 AND "istGekuendigt"=false;'
  + 'COMMIT;'

//
//4.3 Investition zurueckzahlen und Investition tatsaechlich kuendigen
//---------------------------------------------------------------------
exports.tranInvestitionKuendigen = 'BEGIN;'
  + ' INSERT INTO smartinsurance."Zahlungsstrom"("versicherungID", "personID", betrag)'
  + ' SELECT "versicherungID", "personID", investitionshoehe * (-1) FROM smartinsurance."Investition" WHERE smartinsurance."Investition"."wirdGekuendigt"=true;'
  + exports.updateInvestitionGekuendigt
  + 'COMMIT;'

//
//4.4 Sonstige ;-) //TODO: Kommentare einfuegen
//
exports.getPaymentrelevantInvestitions = 'SELECT "v"."id", "i"."personID", "v"."beitrag" * ("i"."invest"/"v"."versicherungshoehe") as "rendite" FROM '
  + '(SELECT "id", "personID", "beitrag", "versicherungshoehe" FROM smartinsurance."Versicherung" WHERE "istGekuendigt"=FALSE) "v" '
  + 'right join '
  + '(SELECT "personID", "versicherungID", sum("investitionshoehe") as "invest" FROM smartinsurance."Investition" WHERE "istGekuendigt"=FALSE GROUP BY "personID", "versicherungID") "i" '
  + 'on "v"."id" = "i"."versicherungID" ;'  //und "wirdGekuendigt" = false????

exports.selectActiveVersicherungAndCalculateBeitrag =
  'SELECT "v"."id", "v"."personID", "v"."versicherungshoehe", "v"."beitrag", "i"."invest", '
  + '"i"."invest"/"v"."versicherungshoehe" as "deckung", "v"."beitrag" * ("i"."invest"/"v"."versicherungshoehe") as "echterBeitrag" from '
  + '(SELECT "id", "personID", "beitrag", "versicherungshoehe" FROM smartinsurance."Versicherung" WHERE "istGekuendigt"=FALSE) "v" '
  + 'left join '
  + '(SELECT "versicherungID", sum("investitionshoehe") as "invest" FROM smartinsurance."Investition" WHERE "istGekuendigt"=FALSE GROUP BY "versicherungID") "i" '
  + 'on "v"."id" = "i"."versicherungID" ;'
